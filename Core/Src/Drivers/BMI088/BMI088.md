
IMU for 6DOF, 16-bit gyro and 16-bit accel
Going to use SPI because SPI is faster
Types of methods needed (from top prio to least):
    - Initiatlization
    - Reset
    - Read Gyro
    - Read Accel
    - Read timing
    - Enable Int Handling
    - Self Test
    - Set ODR/Range


We will be reading the sensor data via burst mode, which automatically increments the starting reading address after each byte and ensures
that the sensor values in all readout registers belong to the same sample

The BMI088 incoroprates a self-test feature for both accelerometer and gyroscope indicating if the sensor is okay

Both acceleroemter and gyro offer new data interrupt, telling us when new data is ready which allows a low latency data readout

We will be using STREAM mode isntead of FIFO to retrieve data instantly

Probably have a time stamp of 39.0625 us

Mapping for SPI can be found on page 44

Timing Diagram for SPI is found on page 46

For a single R/W byte operation 16 bit protocols are used, the data bits are used as follows:
    - Bit 0 is the R/W bit, when 0 means data SDI is written into chip, when 1, the data SDO from the chip is read
    - Bit 1-7 is the address
    - Bit 8-15 when in write mode these are the SDI data which will be written into address, when in read mode these are the data SDO that are being read from the address

Burst read is possible by keeping CSB low and continuing data transfer, only first address register needs to be written.
Addresses are automatically incremented after each read as long as CSB stays active low

For orientation and output signal directions refer to pg 56

To select STREAM mode, then bit 0 in 0x48 must be cleared to 0

Accelerometer

    - SPI Interface:
        - In case of read operations, the requested data is not sent immediately but a dummy byte is sent and after the dummy byte the actual register content is transmitted
        - From above:
            -     For a single R/W byte operation 16 bit protocols are used, the data bits are used as follows:
                    - Bit 0 is the R/W bit, when 0 means data SDI is written into chip, when 1, the data SDO from the chip is read
                    - Bit 1-7 is the address
                    - Bit 8-15 when in write mode these are the SDI data which will be written into address, when in read mode these are the data SDO that are being read from the address
        - Need to read two bytes but disregard the first one


    - Register map is on page 25
        - Registers I would like to use:
            - 0x02 ACC_ERR_REG -> Reports senor error conditions
            - 0x03 ACC_STATUS -> Sensor status flag, data ready to be read
            - 0x12-0x17 ACC_DATA -> Registers containing the acceleration sensor output, stored in signed 16-bit number in 2's complement formrat in 2 registers
                - the conversions can be found in data sheet
            - 0x18-0x1A Sensortime Data -> retrieve timestamp of when data has been sampled
                - Counter overflows every 11 minutes
            - 0x22-0x23 Temperature sensor data -> Registers contain temperature sensor data and is stored in 11 bit in 2's complement
                - Resolution is 0.125C/LSB and temp can be obtained via formula on datasheet
            - 0x40 ACC_CONF -> Accelerometer Config Register
            - 0x41 ACC_RANGE -> Accelerometer range setting register, sets the measurement range
            - 0x6D ACC_SELF_TEST -> Enables sensor self-test signal
            - 0x7C ACC_PWR_CONF -> Switches accelerometer modes
            - 0x7D ACC_PWR_CTRL -> Swithces accelerometer ON and OFF, requried to do after every reset in order to obtain accleration values
            - 0x7E ACC_SOFTRESET -> Writing 0xB6 to the register resets all sensors, needs to be followed up with 1ms delay
            - 0x48 FIFO_CONFIG_0 -> Read in STREAM mode


    - Has a built-in 24-bit counter and automatically increments periodically with a resolution of 39.0625us
    - For the accelerometer ODR (Output Data Rate) we would use somewhere between 200-800 hz ideally (400-800) so we would use Normal or OSR2

    - New data interrupt flag can be found in reg ACC_INT_STAT_1 (bit 7), it is set when new data is ready and cleared automatically


    - Regarding the self test feature:
        - The sensor applies electrostatic force onto the sensor core instead of external accelerations
        - Should be only used under static circumstances, the only acceleration is acceleration due to gravity
        - Recommended Procedure for self test:
            1.) Set +- 24g range by writing 0x03 to ACC_RANGE(0x41)
            2.) Set ODR = 1.6kHz, continuous sampling mode, "normal mode" (norm_avg4) by writing 0xA7 o reg ACC_CONF(0x40)
                - For Continuous Sampling: Set bit7 in ACC_CONF
                - "normal avg4 mode": ACC_CONF |= 0x02 << 4;
                - ODR = 1.6kHz: ACC_CONF |= 0x0C
            3.) Wait for 2ms
            4.) Enable positive self polarity (0x0D to ACC_SELF_TEST(0x6D))
            5.) Wait for >50ms
            6.) Read accelerometer offset values for each axis (positive self-test response)
            7.) Enable neg self-test polarity (0x09 to ACC_SELF_TEST(0x6D))
            8.) Wait for > 50ms
            9.) Read accelerometer offset values for each axis (negative self-test response)
            10.) Disable the self test (0x00 to ACC_SELF_TEST(0x6D))
            11.) Calc diff between postive and neg self-test response and compare with expected vals
                - There are min values:
                    - x axis signal >= 1000mg
                    - y axis signal >= 1000mg
                    - z axis signal >= 500mg
            12.) Wait for >50ms to let sensor settle to normal mode

            Recommended to perform reset after self-test has been performed, if can't be performed disable interrupts,
                        change params of interrupts wait >50ms and enable desired interrupts

    - Power state of BMI088 accel is controlled through ACC_PWR_CTRL
        - It enables and disables the accelerometer and temp sensor
        - There are two modes:
            1. Normal
            2. Suspend
        - on POR, it is automatically set to Suspend so we need to change it to normal
            - To do this, do the following:
                a.) Power up sensor
                b.) Wait 1ms
                c.) Enter normal mode by writing '4' to ACC_PWR_CTRL
                d.) Wait for 450 microseconds

Gyroscope
    - Has 8 different ODR and low pass filter bandwidth settings

    - Registers:
        - Register map can be found at page 36
        - Registers I might use:
            - 0x02 - 0x07 Rate Data -> Contains angular velocity sensor output, 16bit number in 2's complement
                - Rate conversion from LSB to angular velocity (deg per second) is based off settings and forrmula for conversion can be found online
            - 0x0A GYRO_INT_STAT_1 -> Data ready interrupt status, clearede automatically after 280-400 us
            - 0x0F GYRO_RANGE -> Angular rate range and resolution
            - 0x10 GYRO_BANDWIDTH -> Allows selection of rate data filter bandwidth and ODR
            - 0x11 GYRO_LPM1 -> Power mode selection
            - 0x14 GYRO_SOFTRESET -> Soft reset gyroscope
            - 0x15 GYRO_INT_CTRL -> Enable new data interrupt to be triggered on new data
            - 0x16 INT3_INT4_IO_CONF-> set electrical and logical properties of interrupt pins
            - 0x18 INT3_INT4_IO_MAP -> Map data ready interrup to interrupt pins 3 or 4
            - 0x3C GYRO_SELF_TEST -> Built-in self-test gyroscope


    - For Gyroscope sensor test:
        - Continuously run in background and read bit #4 in GYRO_SELF_TEST, if it is 1 then proper sensor function

    - New Data Flag:
        - provides a new data interrupt after storing a new value of z-axis angular rate data in data reg and will be cleared automatically after
                every 280-400 us
        - The interrupt must be explicitly enabled by writing 0x80 to GYRO_INT_CTRL
        - Interrupt can be mapped to interrupt pins INT3 or INT4 in INT3_INT4_IO_MAP

    - Has three different power modes
        1. Normal mode which represents fully operational state
        2. Suspend mode
            - In suspend mode, there is no data accquisition, the latest rate data and config are all kept but not updated
            - Suspend mode is is obtained by writing 0x80 to GYRO_LPM1
            - If you want to go to normal mode write 0x00 to GYRO_LPM1
            - Or do a soft reset to get out of suspend mode
            - Write access to registers is fully supported by SDA and SCL but a waiting period must be inserted between two consectuive write cycles

        3. Deep Suspend mode
            - Lowest power consumption
            - Interface is kept alive but all config reg are lost
            - No data accquisition
            - Can be obtained by writing 0x20 to GYRO_LPM1 and can be left by writing 0x00 to GYRO_LPM1 or soft reset
            - All config settings must be set after leaving deep suspend mode

        Note: after POR, soft-reset or switching between states, the gyroscope sensor needs 30ms to reach the new state. Any comms should be avoided during this time


        Both suspend modes are for power saving


